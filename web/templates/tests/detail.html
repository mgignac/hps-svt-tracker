{% extends "base.html" %}

{% block title %}Test #{{ test.id }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('components.component_detail', component_id=test.component_id) }}">
                        {{ test.component_id }}
                    </a>
                </li>
                <li class="breadcrumb-item active">Test #{{ test.id }}</li>
            </ol>
        </nav>
        <h1><i class="bi bi-graph-up"></i> Test Result #{{ test.id }}</h1>
    </div>
</div>

<!-- Test Information -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Test Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">Component:</dt>
                    <dd class="col-sm-8">
                        <a href="{{ url_for('components.component_detail', component_id=test.component_id) }}">
                            {{ test.component_id }}
                        </a>
                    </dd>

                    <dt class="col-sm-4">Test Type:</dt>
                    <dd class="col-sm-8">{{ test.test_type }}</dd>

                    <dt class="col-sm-4">Test Date:</dt>
                    <dd class="col-sm-8">{{ test.test_date[:19] }}</dd>

                    <dt class="col-sm-4">Result:</dt>
                    <dd class="col-sm-8">
                        {% if test.pass_fail %}
                            <span class="badge bg-success fs-6">
                                <i class="bi bi-check-circle"></i> PASS
                            </span>
                        {% elif test.pass_fail == False %}
                            <span class="badge bg-danger fs-6">
                                <i class="bi bi-x-circle"></i> FAIL
                            </span>
                        {% else %}
                            <span class="badge bg-secondary fs-6">N/A</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">Tested By:</dt>
                    <dd class="col-sm-8">{{ test.tested_by or 'N/A' }}</dd>

                    {% if test.voltage_measured is not none %}
                    <dt class="col-sm-4">Voltage:</dt>
                    <dd class="col-sm-8">{{ test.voltage_measured }} V</dd>
                    {% endif %}

                    {% if test.current_measured is not none %}
                    <dt class="col-sm-4">Current:</dt>
                    <dd class="col-sm-8">{{ "%.2e" | format(test.current_measured) }} A</dd>
                    {% endif %}

                    {% if test.noise_level is not none %}
                    <dt class="col-sm-4">Noise Level:</dt>
                    <dd class="col-sm-8">{{ test.noise_level }}</dd>
                    {% endif %}

                    {% if test.temperature is not none %}
                    <dt class="col-sm-4">Temperature:</dt>
                    <dd class="col-sm-8">{{ test.temperature }} Â°C</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        {% if test.test_setup %}
        <hr>
        <div>
            <strong>Test Setup:</strong>
            <p class="mb-0">{{ test.test_setup }}</p>
        </div>
        {% endif %}

        {% if test.test_conditions %}
        <hr>
        <div>
            <strong>Test Conditions:</strong>
            <p class="mb-0">{{ test.test_conditions }}</p>
        </div>
        {% endif %}

        {% if test.notes %}
        <hr>
        <div>
            <strong>Notes:</strong>
            <p class="mb-0">{{ test.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Additional Measurements -->
{% if measurements_dict %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Additional Measurements</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in measurements_dict.items() %}
                    <tr>
                        <td><strong>{{ key }}</strong></td>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Images -->
{% if image_paths %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="bi bi-images"></i> Images
            <span class="badge bg-secondary">{{ image_paths|length }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for img_path in image_paths %}
            <div class="col-md-6 mb-3">
                <div class="card">
                    <img src="{{ url_for('files.serve_file', filepath=img_path) }}"
                         class="card-img-top"
                         alt="Test image"
                         onerror="this.parentElement.innerHTML='<div class=\'alert alert-warning mb-0\'>Image not found: {{ img_path }}</div>'">
                    <div class="card-footer text-muted small">
                        <i class="bi bi-file-earmark-image"></i> {{ img_path.split('/')[-1] }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Data File -->
{% if test.data_file_path %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Data File</h5>
    </div>
    <div class="card-body">
        <p class="mb-2"><strong>File:</strong> {{ test.data_file_path.split('/')[-1] }}</p>
        <a href="{{ url_for('files.serve_file', filepath=test.data_file_path) }}"
           class="btn btn-primary">
            <i class="bi bi-download"></i> Download Data File
        </a>
    </div>
</div>
{% endif %}
{% endblock %}
