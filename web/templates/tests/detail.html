{% extends "base.html" %}

{% block title %}Test #{{ test.id }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('components.component_detail', component_id=test.component_id) }}">
                        {{ test.component_id }}
                    </a>
                </li>
                <li class="breadcrumb-item active">Test #{{ test.id }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-graph-up"></i> Test Result #{{ test.id }}</h1>
            <!-- Delete button - only visible in edit mode -->
            <form action="{{ url_for('tests.delete_test', test_id=test.id) }}" method="POST"
                  class="edit-mode-only"
                  onsubmit="return confirm('Are you sure you want to delete this test? This action cannot be undone.');">
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Delete Test
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Test Information -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Test Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">Component:</dt>
                    <dd class="col-sm-8">
                        <a href="{{ url_for('components.component_detail', component_id=test.component_id) }}">
                            {{ test.component_id }}
                        </a>
                    </dd>

                    <dt class="col-sm-4">Test Type:</dt>
                    <dd class="col-sm-8">{{ test.test_type|display_test_type }}</dd>

                    <dt class="col-sm-4">Test Date:</dt>
                    <dd class="col-sm-8">{{ test.test_date|format_date }}</dd>

                    <dt class="col-sm-4">Result:</dt>
                    <dd class="col-sm-8">
                        <!-- View mode: show badge -->
                        <span class="view-mode-only">
                            {% if test.pass_fail %}
                                <span class="badge bg-success fs-6">
                                    <i class="bi bi-check-circle"></i> PASS
                                </span>
                            {% elif test.pass_fail == False %}
                                <span class="badge bg-danger fs-6">
                                    <i class="bi bi-x-circle"></i> FAIL
                                </span>
                            {% else %}
                                <span class="badge bg-secondary fs-6">N/A</span>
                            {% endif %}
                        </span>
                        <!-- Edit mode: show form -->
                        <form action="{{ url_for('tests.update_result', test_id=test.id) }}"
                              method="POST" class="d-inline-flex align-items-center gap-2 edit-mode-only">
                            <select name="result" class="form-select form-select-sm" style="width: auto;">
                                <option value="pass" {% if test.pass_fail == True %}selected{% endif %}>PASS</option>
                                <option value="fail" {% if test.pass_fail == False %}selected{% endif %}>FAIL</option>
                                <option value="na" {% if test.pass_fail is none %}selected{% endif %}>N/A</option>
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary">
                                <i class="bi bi-check"></i> Update
                            </button>
                        </form>
                    </dd>
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">Tested By:</dt>
                    <dd class="col-sm-8">{{ test.tested_by or 'N/A' }}</dd>

                    {% if test.voltage_measured is not none %}
                    <dt class="col-sm-4">Voltage:</dt>
                    <dd class="col-sm-8">{{ test.voltage_measured }} V</dd>
                    {% endif %}

                    {% if test.current_measured is not none %}
                    <dt class="col-sm-4">Current:</dt>
                    <dd class="col-sm-8">{{ "%.2e" | format(test.current_measured) }} A</dd>
                    {% endif %}

                    {% if test.noise_level is not none %}
                    <dt class="col-sm-4">Noise Level:</dt>
                    <dd class="col-sm-8">{{ test.noise_level }}</dd>
                    {% endif %}

                    {% if test.temperature is not none %}
                    <dt class="col-sm-4">Temperature:</dt>
                    <dd class="col-sm-8">{{ test.temperature }} °C</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        {% if test.test_setup %}
        <hr>
        <div>
            <strong>Test Setup:</strong>
            <p class="mb-0">{{ test.test_setup }}</p>
        </div>
        {% endif %}

        {% if test.test_conditions %}
        <hr>
        <div>
            <strong>Test Conditions:</strong>
            <p class="mb-0">{{ test.test_conditions }}</p>
        </div>
        {% endif %}

        {% if test.notes %}
        <hr>
        <div>
            <strong>Notes:</strong>
            <p class="mb-0">{{ test.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Special display for Edge Imaging Test -->
{% if test.test_type == 'edge_imaging' and measurements_dict %}
<div class="card mb-4">
    <div class="card-header bg-info bg-opacity-25">
        <h5 class="mb-0"><i class="bi bi-rulers"></i> Edge Gap Measurements</h5>
    </div>
    <div class="card-body">
        <!-- Overall Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="text-muted mb-3">Overall Summary (All Positions)</h6>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-3 h-100">
                    <h4 class="text-primary mb-0">{{ measurements_dict.get('edge_gap_mean', 'N/A') }}</h4>
                    <small class="text-muted">Mean ({{ measurements_dict.get('edge_gap_unit', 'um') }})</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-3 h-100">
                    <h4 class="text-success mb-0">{{ measurements_dict.get('edge_gap_min', 'N/A') }}</h4>
                    <small class="text-muted">Min ({{ measurements_dict.get('edge_gap_unit', 'um') }})</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-3 h-100">
                    <h4 class="text-danger mb-0">{{ measurements_dict.get('edge_gap_max', 'N/A') }}</h4>
                    <small class="text-muted">Max ({{ measurements_dict.get('edge_gap_unit', 'um') }})</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-3 h-100">
                    <h4 class="text-secondary mb-0">{{ measurements_dict.get('edge_gap_count', 'N/A') }}</h4>
                    <small class="text-muted">Measurements</small>
                </div>
            </div>
        </div>

        <!-- Per-Position Measurements -->
        {% set positions = [] %}
        {% for key in measurements_dict.keys() %}
            {% if key.startswith('edge_gap_') and key.endswith('_mean') and key != 'edge_gap_mean' %}
                {% set pos = key.replace('edge_gap_', '').replace('_mean', '') %}
                {% if positions.append(pos) %}{% endif %}
            {% endif %}
        {% endfor %}

        {% if positions %}
        <hr>
        <h6 class="text-muted mb-3">Per-Position Measurements</h6>
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Position</th>
                        <th class="text-center">Mean</th>
                        <th class="text-center">Min</th>
                        <th class="text-center">Max</th>
                        <th class="text-center">Count</th>
                        <th>Individual Values</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pos in positions|sort %}
                    <tr>
                        <td>
                            <strong>{{ pos|upper }}</strong>
                            {% if pos|upper == 'L' %}<span class="text-muted small">(Left)</span>
                            {% elif pos|upper == 'R' %}<span class="text-muted small">(Right)</span>
                            {% elif pos|upper == 'C' %}<span class="text-muted small">(Center)</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-primary">{{ measurements_dict.get('edge_gap_' ~ pos ~ '_mean', 'N/A') }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-success">{{ measurements_dict.get('edge_gap_' ~ pos ~ '_min', 'N/A') }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-danger">{{ measurements_dict.get('edge_gap_' ~ pos ~ '_max', 'N/A') }}</span>
                        </td>
                        <td class="text-center">{{ measurements_dict.get('edge_gap_' ~ pos ~ '_count', 'N/A') }}</td>
                        <td>
                            {% set values = measurements_dict.get('edge_gap_' ~ pos ~ '_values', []) %}
                            {% if values %}
                                <small class="text-muted">{{ values|join(', ') }}</small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Edge Slope Analysis -->
        {% if measurements_dict.get('edge_slope_um_per_mm') is not none %}
        <hr>
        <h6 class="text-muted mb-3">Edge Slope Analysis</h6>
        <div class="row">
            <div class="col-md-3 text-center">
                <div class="border rounded p-3 h-100">
                    <h5 class="text-primary mb-0">{{ measurements_dict.get('edge_slope_um_per_mm') }}</h5>
                    <small class="text-muted">Slope (µm/mm)</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-3 h-100">
                    <h5 class="text-info mb-0">{{ measurements_dict.get('edge_slope_mrad') }}</h5>
                    <small class="text-muted">Slope (mrad)</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-3 h-100">
                    <h5 class="text-warning mb-0">{{ "%.4f"|format(measurements_dict.get('edge_angle_deg', 0)) }}°</h5>
                    <small class="text-muted">Angle</small>
                </div>
            </div>
            <div class="col-md-3 text-center">
                <div class="border rounded p-3 h-100">
                    <h5 class="mb-0 {% if measurements_dict.get('edge_fit_r_squared', 0) > 0.9 %}text-success{% elif measurements_dict.get('edge_fit_r_squared', 0) > 0.7 %}text-warning{% else %}text-danger{% endif %}">
                        {{ measurements_dict.get('edge_fit_r_squared') }}
                    </h5>
                    <small class="text-muted">R² (fit quality)</small>
                </div>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Linear fit: edge_gap = {{ measurements_dict.get('edge_slope_um_per_mm') }} × position + {{ measurements_dict.get('edge_intercept_um') }} µm
                (sensor length: 33.5 mm)
            </small>
        </div>
        {% endif %}

        <!-- All Individual Values -->
        {% if measurements_dict.get('edge_gap_values') %}
        <hr>
        <details>
            <summary class="text-muted" style="cursor: pointer;">
                <i class="bi bi-list-ul"></i> All Individual Measurements ({{ measurements_dict.get('edge_gap_values')|length }})
            </summary>
            <div class="mt-2 p-2 bg-light rounded">
                <small>{{ measurements_dict.get('edge_gap_values')|join(', ') }} {{ measurements_dict.get('edge_gap_unit', 'um') }}</small>
            </div>
        </details>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Additional Measurements (for non-edge-imaging tests or other parameters) -->
{% if measurements_dict %}
{% set filtered_measurements = {} %}
{% for key, value in measurements_dict.items() %}
    {% if test.test_type != 'edge_imaging' or (not key.startswith('edge_gap_') and not key.startswith('edge_slope_') and not key.startswith('edge_angle_') and not key.startswith('edge_intercept_') and not key.startswith('edge_fit_') and key != 'ocr_raw_text') %}
        {% if filtered_measurements.update({key: value}) %}{% endif %}
    {% endif %}
{% endfor %}

{% if filtered_measurements %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Additional Measurements</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in filtered_measurements.items() %}
                    <tr>
                        <td><strong>{{ key }}</strong></td>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Special display for Flange QC Test -->
{% if test.test_type == 'flange_qc_test' and files_by_type.get('plot') %}
<div class="card mb-4">
    <div class="card-header bg-warning bg-opacity-25">
        <h5 class="mb-0">
            <i class="bi bi-diagram-3"></i> Flange QC Test Results
            {% if measurements_dict.get('feb_serial') %}
            <span class="ms-2 text-muted small">FEB: {{ measurements_dict.feb_serial }}</span>
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        <!-- Summary of plot counts -->
        <div class="row mb-4">
            <div class="col-md-4 text-center">
                <div class="border rounded p-3">
                    <h3 class="text-primary mb-0">{{ measurements_dict.get('j1_file_count', 0) }}</h3>
                    <small class="text-muted">J1 Plots</small>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="border rounded p-3">
                    <h3 class="text-primary mb-0">{{ measurements_dict.get('j3_file_count', 0) }}</h3>
                    <small class="text-muted">J3 Plots</small>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="border rounded p-3">
                    <h3 class="text-primary mb-0">{{ measurements_dict.get('j5_file_count', 0) }}</h3>
                    <small class="text-muted">J5 Plots</small>
                </div>
            </div>
        </div>

        <!-- Accordion for each data input -->
        <div class="accordion" id="flangeQcAccordion">
            {% for data_input in ['J1', 'J3', 'J5'] %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ data_input }}">
                    <button class="accordion-button {% if loop.index > 1 %}collapsed{% endif %}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse{{ data_input }}"
                            aria-expanded="{{ 'true' if loop.index == 1 else 'false' }}" aria-controls="collapse{{ data_input }}">
                        <i class="bi bi-{{ loop.index * 2 - 1 }}-circle me-2 text-primary"></i>
                        {{ data_input }} Data Input
                        <span class="badge bg-secondary ms-2">{{ measurements_dict.get(data_input|lower ~ '_file_count', 0) }} plots</span>
                    </button>
                </h2>
                <div id="collapse{{ data_input }}" class="accordion-collapse collapse {% if loop.index == 1 %}show{% endif %}"
                     aria-labelledby="heading{{ data_input }}" data-bs-parent="#flangeQcAccordion">
                    <div class="accordion-body">
                        {% set input_count = measurements_dict.get(data_input|lower ~ '_file_count', 0) %}
                        {% if input_count > 0 %}
                        <div class="row">
                            {% for f in files_by_type.get('plot', []) %}
                                {% if f.metadata_json.get('data_input') == data_input %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <a href="{{ url_for('files.serve_file', filepath=f.file_path) }}" target="_blank">
                                        <img src="{{ url_for('files.serve_file', filepath=f.file_path) }}"
                                             class="card-img-top"
                                             alt="{{ f.original_filename }}"
                                             style="max-height: 300px; object-fit: contain;"
                                             onerror="this.parentElement.innerHTML='<div class=\'alert alert-warning mb-0\'>Image not found</div>'">
                                    </a>
                                    <div class="card-footer text-muted small d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-file-earmark-image"></i> {{ f.metadata_json.get('original_name', f.original_filename) }}</span>
                                        <span>{{ (f.file_size / 1024)|round(1) }} KB</span>
                                    </div>
                                </div>
                            </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> No plots uploaded for this data input.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Test Files -->
{% set file_type_config = {
    'raw_data': {'label': 'Raw Data Files', 'icon': 'bi-file-earmark-binary', 'color': 'primary'},
    'plot': {'label': 'Plots', 'icon': 'bi-graph-up', 'color': 'success'},
    'image': {'label': 'Images', 'icon': 'bi-images', 'color': 'info'},
    'log': {'label': 'Log Files', 'icon': 'bi-file-text', 'color': 'secondary'},
    'other': {'label': 'Other Files', 'icon': 'bi-file-earmark', 'color': 'dark'}
} %}

<!-- Skip plot display for flange_qc_test since we display them grouped above -->
{% for file_type, files in files_by_type.items() %}
{% if not (test.test_type == 'flange_qc_test' and file_type == 'plot') %}
{% if files %}
{% set config = file_type_config.get(file_type, {'label': file_type, 'icon': 'bi-file', 'color': 'secondary'}) %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="bi {{ config.icon }}"></i> {{ config.label }}
            <span class="badge bg-{{ config.color }}">{{ files|length }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% if file_type == 'plot' or file_type == 'image' %}
        <!-- Display images/plots in a grid -->
        <div class="row">
            {% for f in files %}
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <a href="{{ url_for('files.serve_file', filepath=f.file_path) }}" target="_blank">
                        <img src="{{ url_for('files.serve_file', filepath=f.file_path) }}"
                             class="card-img-top"
                             alt="{{ f.original_filename }}"
                             style="max-height: 300px; object-fit: contain;"
                             onerror="this.parentElement.innerHTML='<div class=\'alert alert-warning mb-0\'>Image not found</div>'">
                    </a>
                    <div class="card-footer text-muted small d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-file-earmark-image"></i> {{ f.original_filename }}</span>
                        <span>{{ (f.file_size / 1024)|round(1) }} KB</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Display other files as a list -->
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in files %}
                    <tr>
                        <td><i class="bi {{ config.icon }}"></i> {{ f.original_filename }}</td>
                        <td>{{ (f.file_size / 1024)|round(1) }} KB</td>
                        <td>
                            <a href="{{ url_for('files.serve_file', filepath=f.file_path) }}"
                               class="btn btn-sm btn-outline-primary" download>
                                <i class="bi bi-download"></i> Download
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}
{% endfor %}
{% endblock %}
