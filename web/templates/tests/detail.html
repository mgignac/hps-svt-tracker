{% extends "base.html" %}

{% block title %}Test #{{ test.id }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('components.component_detail', component_id=test.component_id) }}">
                        {{ test.component_id }}
                    </a>
                </li>
                <li class="breadcrumb-item active">Test #{{ test.id }}</li>
            </ol>
        </nav>
        <h1><i class="bi bi-graph-up"></i> Test Result #{{ test.id }}</h1>
    </div>
</div>

<!-- Test Information -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Test Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">Component:</dt>
                    <dd class="col-sm-8">
                        <a href="{{ url_for('components.component_detail', component_id=test.component_id) }}">
                            {{ test.component_id }}
                        </a>
                    </dd>

                    <dt class="col-sm-4">Test Type:</dt>
                    <dd class="col-sm-8">{{ test.test_type }}</dd>

                    <dt class="col-sm-4">Test Date:</dt>
                    <dd class="col-sm-8">{{ test.test_date[:19] }}</dd>

                    <dt class="col-sm-4">Result:</dt>
                    <dd class="col-sm-8">
                        {% if test.pass_fail %}
                            <span class="badge bg-success fs-6">
                                <i class="bi bi-check-circle"></i> PASS
                            </span>
                        {% elif test.pass_fail == False %}
                            <span class="badge bg-danger fs-6">
                                <i class="bi bi-x-circle"></i> FAIL
                            </span>
                        {% else %}
                            <span class="badge bg-secondary fs-6">N/A</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">Tested By:</dt>
                    <dd class="col-sm-8">{{ test.tested_by or 'N/A' }}</dd>

                    {% if test.voltage_measured is not none %}
                    <dt class="col-sm-4">Voltage:</dt>
                    <dd class="col-sm-8">{{ test.voltage_measured }} V</dd>
                    {% endif %}

                    {% if test.current_measured is not none %}
                    <dt class="col-sm-4">Current:</dt>
                    <dd class="col-sm-8">{{ "%.2e" | format(test.current_measured) }} A</dd>
                    {% endif %}

                    {% if test.noise_level is not none %}
                    <dt class="col-sm-4">Noise Level:</dt>
                    <dd class="col-sm-8">{{ test.noise_level }}</dd>
                    {% endif %}

                    {% if test.temperature is not none %}
                    <dt class="col-sm-4">Temperature:</dt>
                    <dd class="col-sm-8">{{ test.temperature }} Â°C</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        {% if test.test_setup %}
        <hr>
        <div>
            <strong>Test Setup:</strong>
            <p class="mb-0">{{ test.test_setup }}</p>
        </div>
        {% endif %}

        {% if test.test_conditions %}
        <hr>
        <div>
            <strong>Test Conditions:</strong>
            <p class="mb-0">{{ test.test_conditions }}</p>
        </div>
        {% endif %}

        {% if test.notes %}
        <hr>
        <div>
            <strong>Notes:</strong>
            <p class="mb-0">{{ test.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Additional Measurements -->
{% if measurements_dict %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Additional Measurements</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, value in measurements_dict.items() %}
                    <tr>
                        <td><strong>{{ key }}</strong></td>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Special display for Flange QC Test -->
{% if test.test_type == 'flange_qc_test' and files_by_type.get('plot') %}
<div class="card mb-4">
    <div class="card-header bg-warning bg-opacity-25">
        <h5 class="mb-0">
            <i class="bi bi-diagram-3"></i> Flange QC Test Results
            {% if measurements_dict.get('feb_serial') %}
            <span class="ms-2 text-muted small">FEB: {{ measurements_dict.feb_serial }}</span>
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        <!-- Summary of plot counts -->
        <div class="row mb-4">
            <div class="col-md-4 text-center">
                <div class="border rounded p-3">
                    <h3 class="text-primary mb-0">{{ measurements_dict.get('j1_file_count', 0) }}</h3>
                    <small class="text-muted">J1 Plots</small>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="border rounded p-3">
                    <h3 class="text-primary mb-0">{{ measurements_dict.get('j3_file_count', 0) }}</h3>
                    <small class="text-muted">J3 Plots</small>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="border rounded p-3">
                    <h3 class="text-primary mb-0">{{ measurements_dict.get('j5_file_count', 0) }}</h3>
                    <small class="text-muted">J5 Plots</small>
                </div>
            </div>
        </div>

        <!-- Accordion for each data input -->
        <div class="accordion" id="flangeQcAccordion">
            {% for data_input in ['J1', 'J3', 'J5'] %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ data_input }}">
                    <button class="accordion-button {% if loop.index > 1 %}collapsed{% endif %}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse{{ data_input }}"
                            aria-expanded="{{ 'true' if loop.index == 1 else 'false' }}" aria-controls="collapse{{ data_input }}">
                        <i class="bi bi-{{ loop.index * 2 - 1 }}-circle me-2 text-primary"></i>
                        {{ data_input }} Data Input
                        <span class="badge bg-secondary ms-2">{{ measurements_dict.get(data_input|lower ~ '_file_count', 0) }} plots</span>
                    </button>
                </h2>
                <div id="collapse{{ data_input }}" class="accordion-collapse collapse {% if loop.index == 1 %}show{% endif %}"
                     aria-labelledby="heading{{ data_input }}" data-bs-parent="#flangeQcAccordion">
                    <div class="accordion-body">
                        {% set input_count = measurements_dict.get(data_input|lower ~ '_file_count', 0) %}
                        {% if input_count > 0 %}
                        <div class="row">
                            {% for f in files_by_type.get('plot', []) %}
                                {% if f.metadata_json.get('data_input') == data_input %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <a href="{{ url_for('files.serve_file', filepath=f.file_path) }}" target="_blank">
                                        <img src="{{ url_for('files.serve_file', filepath=f.file_path) }}"
                                             class="card-img-top"
                                             alt="{{ f.original_filename }}"
                                             style="max-height: 300px; object-fit: contain;"
                                             onerror="this.parentElement.innerHTML='<div class=\'alert alert-warning mb-0\'>Image not found</div>'">
                                    </a>
                                    <div class="card-footer text-muted small d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-file-earmark-image"></i> {{ f.metadata_json.get('original_name', f.original_filename) }}</span>
                                        <span>{{ (f.file_size / 1024)|round(1) }} KB</span>
                                    </div>
                                </div>
                            </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> No plots uploaded for this data input.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Test Files -->
{% set file_type_config = {
    'raw_data': {'label': 'Raw Data Files', 'icon': 'bi-file-earmark-binary', 'color': 'primary'},
    'plot': {'label': 'Plots', 'icon': 'bi-graph-up', 'color': 'success'},
    'image': {'label': 'Images', 'icon': 'bi-images', 'color': 'info'},
    'log': {'label': 'Log Files', 'icon': 'bi-file-text', 'color': 'secondary'},
    'other': {'label': 'Other Files', 'icon': 'bi-file-earmark', 'color': 'dark'}
} %}

<!-- Skip plot display for flange_qc_test since we display them grouped above -->
{% for file_type, files in files_by_type.items() %}
{% if not (test.test_type == 'flange_qc_test' and file_type == 'plot') %}
{% if files %}
{% set config = file_type_config.get(file_type, {'label': file_type, 'icon': 'bi-file', 'color': 'secondary'}) %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="bi {{ config.icon }}"></i> {{ config.label }}
            <span class="badge bg-{{ config.color }}">{{ files|length }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% if file_type == 'plot' or file_type == 'image' %}
        <!-- Display images/plots in a grid -->
        <div class="row">
            {% for f in files %}
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <a href="{{ url_for('files.serve_file', filepath=f.file_path) }}" target="_blank">
                        <img src="{{ url_for('files.serve_file', filepath=f.file_path) }}"
                             class="card-img-top"
                             alt="{{ f.original_filename }}"
                             style="max-height: 300px; object-fit: contain;"
                             onerror="this.parentElement.innerHTML='<div class=\'alert alert-warning mb-0\'>Image not found</div>'">
                    </a>
                    <div class="card-footer text-muted small d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-file-earmark-image"></i> {{ f.original_filename }}</span>
                        <span>{{ (f.file_size / 1024)|round(1) }} KB</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Display other files as a list -->
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in files %}
                    <tr>
                        <td><i class="bi {{ config.icon }}"></i> {{ f.original_filename }}</td>
                        <td>{{ (f.file_size / 1024)|round(1) }} KB</td>
                        <td>
                            <a href="{{ url_for('files.serve_file', filepath=f.file_path) }}"
                               class="btn btn-sm btn-outline-primary" download>
                                <i class="bi bi-download"></i> Download
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}
{% endfor %}
{% endblock %}
