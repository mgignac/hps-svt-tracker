{% extends "base.html" %}

{% block title %}Upload IV Test - {{ app_name }}{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('upload.index') }}">Upload</a></li>
        <li class="breadcrumb-item active" aria-current="page">IV Test</li>
    </ol>
</nav>

<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="bi bi-graph-up"></i> Upload IV Test Result</h1>
        <p class="text-muted">Record a current-voltage (IV) test measurement for a component</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <form method="post" enctype="multipart/form-data">
            <!-- Upload Mode Toggle -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-toggles"></i> Upload Mode</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group w-100" role="group" aria-label="Upload mode">
                        <input type="radio" class="btn-check" name="upload_mode" id="mode_single" value="single" checked>
                        <label class="btn btn-outline-primary" for="mode_single">
                            <i class="bi bi-file-earmark"></i> Single Upload
                        </label>
                        <input type="radio" class="btn-check" name="upload_mode" id="mode_bulk" value="bulk">
                        <label class="btn btn-outline-primary" for="mode_bulk">
                            <i class="bi bi-files"></i> Bulk Upload
                        </label>
                    </div>
                    <div class="form-text mt-2">
                        <span id="mode_description_single">Upload a single IV test for one component.</span>
                        <span id="mode_description_bulk" style="display: none;">
                            Upload multiple files at once. Component ID is extracted from filename
                            (e.g., <code>W01_S2_data.xlsx</code> → <code>W1-S2-2025</code>).
                        </span>
                    </div>
                </div>
            </div>

            <!-- Component Selection (Single mode only) -->
            <div class="card mb-4" id="component_card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-cpu"></i> Component</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="component_id" class="form-label">Component ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="component_id" name="component_id"
                               list="component_list"
                               placeholder="Enter or select a component ID"
                               value="{{ prefill_component_id }}">
                        <datalist id="component_list">
                            {% for comp_id in component_ids %}
                            <option value="{{ comp_id }}">
                            {% endfor %}
                        </datalist>
                        <div class="form-text">Start typing to see matching component IDs</div>
                    </div>
                </div>
            </div>

            <!-- Test Result -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Test Result</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Pass/Fail Status</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="pass_fail" id="pass_fail_pass" value="pass">
                                <label class="form-check-label text-success" for="pass_fail_pass">
                                    <i class="bi bi-check-circle"></i> Pass
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="pass_fail" id="pass_fail_fail" value="fail">
                                <label class="form-check-label text-danger" for="pass_fail_fail">
                                    <i class="bi bi-x-circle"></i> Fail
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="pass_fail" id="pass_fail_na" value="" checked>
                                <label class="form-check-label text-muted" for="pass_fail_na">
                                    N/A
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Uploads -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-arrow-up"></i> Files</h5>
                </div>
                <div class="card-body">
                    <!-- Raw Data Files -->
                    <div class="mb-4">
                        <label for="raw_data" class="form-label">Raw Data Files</label>
                        <input type="file" class="form-control" id="raw_data" name="raw_data"
                               accept=".csv,.txt,.dat,.tsv,.hdf5,.h5,.root,.json,.xlsx,.xls" multiple>
                        <div class="form-text">
                            IV curve data (voltage/current pairs). Allowed: {{ allowed_data_extensions|join(', ') }}
                        </div>
                    </div>

                    <!-- Auto-analyze option -->
                    {% if iv_analysis_available %}
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="analyze_data" name="analyze_data" checked>
                            <label class="form-check-label" for="analyze_data">
                                <i class="bi bi-graph-up-arrow text-primary"></i>
                                <strong>Auto-analyze data file</strong>
                            </label>
                        </div>
                        <div class="form-text ms-4">
                            Automatically extract measurements and generate IV curve plot from uploaded data file.
                            Supports Excel (.xlsx, .xls), CSV, and text files with voltage/current columns.
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Test Metadata -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Test Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tested_by" class="form-label">Tested By</label>
                            <input type="text" class="form-control" id="tested_by" name="tested_by"
                                   placeholder="Leave blank for current user">
                            <div class="form-text">Defaults to your system username</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="test_setup" class="form-label">Test Setup</label>
                            <input type="text" class="form-control" id="test_setup" name="test_setup"
                                   placeholder="e.g., Probe Station 1">
                            <div class="form-text">Equipment or test bench used</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="test_conditions" class="form-label">Test Conditions</label>
                        <textarea class="form-control" id="test_conditions" name="test_conditions" rows="2"
                                  placeholder="e.g., Dark box, humidity 40%, ..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"
                                  placeholder="Any additional observations or comments"></textarea>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-upload"></i> Submit IV Test
                </button>
                <a href="{{ url_for('upload.index') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            </div>
        </form>
    </div>

    <!-- Help Panel -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> IV Test Guide</h5>
            </div>
            <div class="card-body">
                <h6>What is an IV Test?</h6>
                <p class="small">
                    An IV (Current-Voltage) test measures the relationship between applied voltage
                    and resulting current through a silicon sensor. This characterizes:
                </p>
                <ul class="small">
                    <li><strong>Leakage current</strong> - Current at operating voltage</li>
                    <li><strong>Breakdown voltage</strong> - Voltage where sensor fails</li>
                    <li><strong>Depletion voltage</strong> - Full depletion point</li>
                </ul>

                <hr>

                <h6>Automatic Analysis</h6>
                <p class="small">
                    Upload an Excel or CSV file with IV data and the system will:
                </p>
                <ul class="small">
                    <li>Extract voltage range and current at max voltage</li>
                    <li>Generate an IV curve plot automatically</li>
                    <li>Store all data points for future reference</li>
                </ul>

                <hr>

                <h6>Expected Data Format</h6>
                <p class="small">
                    Data files should have two columns (no headers required):
                </p>
                <pre class="small bg-light p-2 rounded">Column 1: Voltage (V)
Column 2: Current (A)

Example:
0, 2.95e-05
5, 2.01e-06
10, 2.05e-06
...</pre>

                <hr>

                <h6>Pass/Fail Criteria</h6>
                <p class="small mb-0">
                    Typical pass criteria:
                </p>
                <ul class="small">
                    <li>Leakage current below threshold at operating voltage</li>
                    <li>Breakdown voltage above safety margin</li>
                    <li>No anomalous current spikes</li>
                </ul>

                <hr>

                <h6>Bulk Upload</h6>
                <p class="small">
                    For bulk uploads, sensor IDs are extracted from filenames:
                </p>
                <pre class="small bg-light p-2 rounded">W01_S2_data.xlsx → W1-S2-2025
W03_S5_test.csv  → W3-S5-2025</pre>
                <p class="small mb-0">
                    Format: <code>W##_S#_*</code> where ## is wafer number and # is sensor number.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle between single and bulk upload modes
document.querySelectorAll('input[name="upload_mode"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        const isBulk = this.value === 'bulk';
        const componentCard = document.getElementById('component_card');
        const componentInput = document.getElementById('component_id');
        const descSingle = document.getElementById('mode_description_single');
        const descBulk = document.getElementById('mode_description_bulk');

        if (isBulk) {
            componentCard.style.display = 'none';
            componentInput.removeAttribute('required');
            descSingle.style.display = 'none';
            descBulk.style.display = 'inline';
        } else {
            componentCard.style.display = 'block';
            componentInput.setAttribute('required', 'required');
            descSingle.style.display = 'inline';
            descBulk.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
